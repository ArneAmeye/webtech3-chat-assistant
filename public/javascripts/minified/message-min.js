class Message{constructor(){null==localStorage.getItem("token")&&(document.location.href="http://localhost:3000/login"),getAllMessages();const e=document.querySelector(".messages"),t=document.querySelector("#myMessage"),s=document.querySelector(".btn--send");let a=this;this.primus=Primus.connect("/",{reconnect:{max:1/0,min:500,retries:10}});let n=localStorage.getItem("username");document.querySelector(".title--name-me").innerHTML=n,document.querySelector(".btn--logout").addEventListener("click",function(e){a.primus.write({action:"liveUserGone",username:localStorage.getItem("username")}),localStorage.removeItem("token"),localStorage.removeItem("user_id"),localStorage.removeItem("username"),document.location.href="http://localhost:3000/login",e.preventDefault()}),this.primus.on("bot",function(e){console.log(e)}),this.primus.on("data",function(t){if(console.log(t),t.message){let a=document.createElement("div");a.classList.add("messageWrapper","flex","flex--container"),a.dataset.id=t.id;let n=` \n                <div class="profile flex flex--container">\n                    <img class="profpic flex--item" src="https://fakeimg.pl/75x75/" alt="profPic">\n                    <h4 class="title title--name flex--item" data-user_id="${t.user_id}">${t.username}</h4>\n                </div>\n\n                <h3 class="message title title--message flex--item">${t.message}</h3>\n                <h5 class="message--time title title--time flex--item">Timestamp here</h5>\n\n                <div class="iconsWrap flex--item">\n                    <img class="icons icons--pen" src="../images/edit.svg" alt="penIcon">\n                    <img class="icons icons--trash" src="../images/delete.svg" alt="trashIcon">\n                </div>\n                `;a.innerHTML=n,e.appendChild(a),ShowActions();var s=document.querySelector(".messages");s.scrollTop=s.scrollHeight}if("delete"==t.action){console.log(t);let e=document.querySelector(`[data-id="${t.messageId}"]`);e.querySelector(".title--message").innerHTML="This message is deleted by it's user",e.querySelector(".title--message").classList.add("title--message--deleted")}if("update"==t.action){console.log(t);let e=document.querySelector(`[data-id="${t.messageId}"]`);t.updatedMessage+=" (edited)",e.querySelector(".title--message").innerHTML=t.updatedMessage,e.querySelector(".title--message").style.fontStyle="italic"}if("liveUser"==t.action){let e=document.createElement("div");e.classList.add("profile","profile--friends","flex","flex--container"),e.dataset.username=t.username;let s=`\n                    <img class="profpic flex--item" src="https://api.adorable.io/avatars/75/abott@adorable.png" alt="profPic">\n                    <h4 class="title title--name flex--item">${t.username}</h4>\n                `;e.innerHTML=s,document.querySelector(".online").appendChild(e)}if("liveUserGone"==t.action){let e=document.querySelector(`[data-username="${t.username}"]`);e.parentNode.removeChild(e)}}),s.addEventListener("click",function(e){let s=t.value;navigator.geolocation.getCurrentPosition(e=>{localStorage.setItem("lat",e.coords.latitude),localStorage.setItem("lng",e.coords.longitude)}),fetch("/api/v1/messages",{method:"post",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({message:s,lat:localStorage.getItem("lat"),lng:localStorage.getItem("lng")})}).then(e=>e.json()).then(e=>{"success"==e.status&&a.primus.write({message:s,username:e.message.username,user_id:e.message.user_id,id:e.message._id})}),t.value="",e.preventDefault(a)}),t.addEventListener("keypress",function(e){if(13===(e.which||e.keyCode)){let s=t.value;navigator.geolocation.getCurrentPosition(e=>{localStorage.setItem("lat",e.coords.latitude),localStorage.setItem("lng",e.coords.longitude)}),fetch("/api/v1/messages",{method:"post",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({message:s,lat:localStorage.getItem("lat"),lng:localStorage.getItem("lng")})}).then(e=>e.json()).then(e=>{"success"==e.status&&a.primus.write({message:s,username:e.message.username,user_id:e.message.user_id,id:e.message._id})}),t.value="",e.preventDefault()}}),e.addEventListener("click",function(e){if(e.target.matches(".icons--trash")){let t=e.target.parentElement.parentElement.dataset.id;fetch(`/api/v1/messages/${t}`,{method:"delete",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({})}).then(e=>e.json()).then(e=>{console.log(e),"success"==e.status&&a.primus.write({action:"delete",messageId:t})})}}),e.addEventListener("click",function(e){if(e.target.matches(".icons--pen")){let t=e.target.parentElement.parentElement.dataset.id,s=e.target.parentElement.previousElementSibling.previousElementSibling,n=document.createElement("input");n.classList.add("message","title","title-message","flex--item","input","input--message"),n.value=s.innerHTML,s.parentNode.replaceChild(n,s),n.addEventListener("keypress",function(e){if(13===(e.which||e.keyCode)){let e=n.value;fetch(`/api/v1/messages/${t}`,{method:"put",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({message:e})}).then(e=>e.json()).then(s=>{if(console.log(s),"success"==s.status){let s=document.createElement("h3");s.classList.add("message","title","title--message","flex--item"),s.innerHTML=n.value,n.parentNode.replaceChild(s,n),a.primus.write({action:"update",messageId:t,updatedMessage:e})}})}})}})}}function getAllMessages(){fetch("/api/v1/messages",{method:"get",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}}).then(e=>e.json()).then(e=>{if(console.log(e),"success"==e.status){for(i=0;i<e.data.length;i++){let t=document.createElement("div");t.classList.add("messageWrapper","flex","flex--container"),t.dataset.id=e.data[i]._id;let s=` \n                <div class="profile flex flex--container">\n                    <img class="profpic flex--item" src="https://fakeimg.pl/75x75/" alt="profPic">\n                    <h4 class="title title--name flex--item" data-user_id="${e.data[i].user_id}">${e.data[i].username}</h4>\n                </div>\n\n                <h3 class="message title title--message flex--item">${e.data[i].message}</h3>\n                <h5 class="message--time title title--time flex--item">Timestamp here</h5>\n\n                <div class="iconsWrap flex--item">\n                    <img class="icons icons--pen" src="../images/edit.svg" alt="penIcon">\n                    <img class="icons icons--trash" src="../images/delete.svg" alt="trashIcon">\n                </div>\n                `;t.innerHTML=s,document.querySelector(".messages").appendChild(t)}var t=document.querySelector(".messages");t.scrollTop=t.scrollHeight}ShowActions()})}function ShowActions(){let e=localStorage.getItem("user_id"),t=document.querySelectorAll(`[data-user_id="${e}"]`);for(i=0;i<t.length;i++){t[i].parentElement.parentElement.querySelector(".iconsWrap").style.display="block"}}let message=new Message;